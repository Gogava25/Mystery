<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MegaTool Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;       /* slate-900 */
      --panel: #111827;    /* gray-900 */
      --muted: #94a3b8;    /* slate-400 */
      --text: #e5e7eb;     /* gray-200 */
      --accent: #22d3ee;   /* cyan-400 */
      --good: #22c55e;     /* green-500 */
      --warn: #f59e0b;     /* amber-500 */
      --bad:  #ef4444;     /* red-500 */
      --chip: #1f2937;     /* gray-800 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 100% -10%, #0b1024 0%, #0f172a 50%, #0b1024 100%);
      color: var(--text);
    }
    header {
      padding: 20px 16px;
      border-bottom: 1px solid #1f2937;
      display: flex; align-items: center; justify-content: space-between;
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: .3px; }
    .accent { color: var(--accent); }
    .wrap { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
    .card { background: rgba(17, 24, 39, .75); border: 1px solid #1f2937; border-radius: 12px; overflow: hidden; }
    .card h2 { font-size: 16px; margin: 0; padding: 12px 14px; border-bottom: 1px solid #1f2937; background: #0b1224; }
    .section { padding: 12px 14px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .btn {
      background: #0b1224; border: 1px solid #213053; color: var(--text);
      padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all .15s;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px; background: var(--chip); border: 1px solid #303a53;
      padding: 6px 8px; border-radius: 999px; font-size: 12px; color: var(--muted);
    }
    .pill b { color: var(--text); font-weight: 600; }
    .user-card {
      background: rgba(3, 7, 18, .5); border: 1px solid #1f2937; border-radius: 10px; padding: 12px; margin-bottom: 10px;
    }
    .user-head { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .user-head h3 { margin: 0; font-size: 15px; }
    .kv { display: grid; grid-template-columns: 160px 1fr; gap: 4px 12px; margin: 8px 0; font-size: 13px; }
    .muted { color: var(--muted); }
    code.time { background: #0b1224; padding: 2px 6px; border-radius: 6px; border: 1px solid #213053; }
    pre.logs {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap; word-break: break-word; background: #0b1224; border: 1px solid #213053;
      padding: 10px; border-radius: 10px; max-height: 520px; overflow: auto; font-size: 12px;
    }
    .ok { color: var(--good); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .grid-2 { display: grid; grid-template-columns: auto 1fr; gap: 10px; }
    @media (max-width: 680px) { .grid-2 { grid-template-columns: 1fr; } }
    .sep { height: 1px; background: #1f2937; margin: 10px 0; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>MegaTool <span class="accent">Dashboard</span></h1>
    <div class="row">
      <button class="btn small" id="refreshAll">Refresh All Panels</button>
      <label class="pill"><input type="checkbox" id="autoTick" style="accent-color:#22d3ee" /> Auto-refresh (10s)</label>
    </div>
  </header>

  <div class="wrap grid">
    <div class="card">
      <h2>Users & Schedules</h2>
      <div class="section" id="usersPanel">Loading users…</div>
    </div>

    <div class="card">
      <h2>API Debug Logs</h2>
      <div class="section">
        <div class="row" style="margin-bottom:8px;">
          <button class="btn small" id="refreshLogs">Refresh</button>
          <span class="muted small">Showing latest <span id="logLimit"></span> entries</span>
        </div>
        <pre class="logs" id="logsBox">Loading debug logs…</pre>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const DEBUG_LIMIT = 100;   // how many debug log rows
    const USER_LOG_LIMIT = 50; // per-user activity (if you want to fetch later)
    document.getElementById('logLimit').textContent = DEBUG_LIMIT;

    // --- Utilities ---
    const pad2 = n => n.toString().padStart(2, '0');

    function fmtUTC(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (isNaN(d)) return '—';
      return d.toUTCString();
    }
    function fmtLocal(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      if (isNaN(d)) return '—';
      return d.toLocaleString();
    }
    function minsFromNow(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const diff = Math.round((d - Date.now()) / 60000);
      if (isNaN(diff)) return '';
      return diff >= 0 ? `in ${diff}m` : `${diff}m ago`;
    }
    function toIso(val) {
      // val may already be ISO string or a Date serialized by backend
      if (!val) return null;
      try {
        const d = new Date(val);
        return isNaN(d) ? null : d.toISOString();
      } catch { return null; }
    }

    // Compute planned achievements times on the client
    function computePlannedAchievements(user) {
      const effStartISO = toIso(user._effectiveStartUTC);
      const effEndISO   = toIso(user._effectiveEndUTC);
      if (!effStartISO || !effEndISO) return null;

      const start = new Date(effStartISO);
      const end   = new Date(effEndISO);

      const claim1 = new Date(start.getTime() + 5 * 60 * 1000);
      const claim2 = new Date(claim1.getTime() + 5 * 60 * 60 * 1000);
      const claim3 = new Date(end.getTime() - 5 * 60 * 1000);

      return {
        claim1ISO: claim1.toISOString(),
        claim2ISO: claim2.toISOString(),
        claim3ISO: claim3.toISOString()
      };
    }

    // --- API fetchers (backend provides these) ---
    async function fetchUsers() {
      const r = await fetch('/api/users');
      if (!r.ok) throw new Error('Failed to fetch /api/users');
      return r.json(); // returns userData object keyed by userId
    }

    async function fetchDebugLogs(limit = DEBUG_LIMIT) {
      const r = await fetch(`/api/debug-logs?limit=${encodeURIComponent(limit)}`);
      if (!r.ok) throw new Error('Failed to fetch /api/debug-logs');
      return r.json();
    }

    async function action(userId, route) {
      const r = await fetch(`/api/user/${encodeURIComponent(userId)}/${route}`, { method: 'POST' });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j?.message || `Action ${route} failed`);
      return j;
    }

    // --- Renderers ---
    function renderUsers(users) {
      const panel = document.getElementById('usersPanel');
      const ids = Object.keys(users);
      if (!ids.length) {
        panel.innerHTML = '<div class="muted">No users loaded.</div>';
        return;
      }

      const parts = [];
      ids.forEach((id) => {
        const u = users[id] || {};

        const effStartISO = toIso(u._effectiveStartUTC);
        const effEndISO   = toIso(u._effectiveEndUTC);
        const jitter = (typeof u._startJitterMin === 'number') ? `${u._startJitterMin}m` : '—';
        const ach = computePlannedAchievements(u);

        parts.push(`
          <div class="user-card" data-user="${id}">
            <div class="user-head">
              <h3>${id}</h3>
              <div class="row">
                <button class="btn small" data-act="refresh" data-id="${id}">Refresh JWT</button>
                <button class="btn small" data-act="spin" data-id="${id}">Spin</button>
                <button class="btn small" data-act="claim" data-id="${id}">Claim Ach.</button>
                <button class="btn small" data-act="funds" data-id="${id}">Check Funds</button>
              </div>
            </div>

            <div class="kv">
              <div class="muted">Active</div>
              <div>${u.isActive ? '<span class="ok">Yes</span>' : '<span class="bad">No</span>'}</div>

              <div class="muted">Effective Start (UTC / Local)</div>
              <div><code class="time">${fmtUTC(effStartISO)}</code> / <code class="time">${fmtLocal(effStartISO)}</code> <span class="pill">jitter <b>${jitter}</b></span></div>

              <div class="muted">Effective End (UTC / Local)</div>
              <div><code class="time">${fmtUTC(effEndISO)}</code> / <code class="time">${fmtLocal(effEndISO)}</code></div>

              <div class="muted">Planned Achievements</div>
              <div>
                ${ach ? `
                  <div class="grid-2 small">
                    <div>#1 Start+5m</div><div><code class="time">${fmtUTC(ach.claim1ISO)}</code> · ${minsFromNow(ach.claim1ISO)}</div>
                    <div>#2 +5h</div><div><code class="time">${fmtUTC(ach.claim2ISO)}</code> · ${minsFromNow(ach.claim2ISO)}</div>
                    <div>#3 End-5m</div><div><code class="time">${fmtUTC(ach.claim3ISO)}</code> · ${minsFromNow(ach.claim3ISO)}</div>
                  </div>` : '<span class="muted">Not scheduled yet (will appear after daily plan initializes)</span>'
                }
              </div>

              <div class="muted">Next Spin</div>
              <div><code class="time">${fmtUTC(u.nextSpinTime)}</code> · ${minsFromNow(u.nextSpinTime)}</div>

              <div class="muted">Spins / Achievements Claimed</div>
              <div>${u.spinCount ?? 0} / ${u.achievementsClaimed ?? 0}</div>

              <div class="muted">Last Funds / Daily Funds Checks</div>
              <div>${(u.lastFunds ?? 0).toLocaleString()} / ${u.dailyFundsChecks ?? 0}</div>
            </div>
          </div>
        `);
      });

      panel.innerHTML = parts.join('\n');
      panel.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const act = e.currentTarget.getAttribute('data-act');
          e.currentTarget.disabled = true;
          try {
            if (act === 'refresh') await action(id, 'refresh');
            if (act === 'spin')    await action(id, 'spin');
            if (act === 'claim')   await action(id, 'claim-achievements');
            if (act === 'funds')   await action(id, 'check-funds');
          } catch (err) {
            alert(err.message || String(err));
          } finally {
            e.currentTarget.disabled = false;
            // refresh users + logs after an action
            loadUsers().catch(()=>{});
            loadLogs().catch(()=>{});
          }
        });
      });
    }

    function renderLogs(list) {
      const box = document.getElementById('logsBox');
      if (!Array.isArray(list) || !list.length) {
        box.textContent = 'No debug logs yet.';
        return;
      }
      const lines = list.map((entry) => {
        // entry fields come from server debugLog() response structure
        // we keep it simple: timestamp, userId, action, request URL, status / error
        const ts = entry.timestamp || '';
        const who = entry.userId || 'system';
        const action = entry.action || '';
        const req = entry.request || {};
        const url = req.url || '';
        const method = req.method || '';
        const resp = entry.response;
        const err  = entry.error;

        if (resp) {
          return `[${ts}] [${who}] ${action} ${method} ${url} -> ${resp.status}`;
        } else if (err) {
          return `[${ts}] [${who}] ${action} ${method} ${url} -> ERROR ${err.status || ''} ${err.message}`;
        } else {
          return `[${ts}] [${who}] ${action} ${method} ${url}`;
        }
      });
      box.textContent = lines.join('\n');
    }

    // --- Loaders ---
    async function loadUsers() {
      try {
        const data = await fetchUsers();
        renderUsers(data);
      } catch (e) {
        document.getElementById('usersPanel').innerHTML = `<span class="bad">Failed to load users: ${e.message}</span>`;
      }
    }

    async function loadLogs() {
      try {
        const logs = await fetchDebugLogs(DEBUG_LIMIT);
        renderLogs(logs);
      } catch (e) {
        document.getElementById('logsBox').textContent = `Failed to load debug logs: ${e.message}`;
      }
    }

    // --- Wire up controls ---
    document.getElementById('refreshAll').addEventListener('click', () => {
      loadUsers(); loadLogs();
    });
    document.getElementById('refreshLogs').addEventListener('click', () => loadLogs());

    // Auto refresh toggle
    let tickHandle = null;
    document.getElementById('autoTick').addEventListener('change', (e) => {
      if (e.target.checked) {
        tickHandle = setInterval(() => { loadUsers(); loadLogs(); }, 10_000);
      } else {
        if (tickHandle) clearInterval(tickHandle);
        tickHandle = null;
      }
    });

    // Initial load
    loadUsers();
    loadLogs();
  </script>
</body>
</html>
